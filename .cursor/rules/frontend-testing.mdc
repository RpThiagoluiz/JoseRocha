---
description: Standards for writing Unit and Integration tests (Jest/React Testing Library)
globs: ['**/*.test.tsx', '**/*.spec.ts', '**/*.spec.tsx', '**/__tests__/**/*']
alwaysApply: false
---

# Testing Guidelines

Follow these rules when writing or refactoring tests. The goal is to create **resilient, product-relevant** tests that survive refactors.

## 1. Core Philosophy: Behavior > Implementation

- **Do NOT test implementation details**: Avoid internal state, private helpers, or specific CSS class names unless absolutely necessary.
- **Test what the user sees and does**: Focus on labels, buttons, messages, navigation and visible feedback.
- **Product relevance**: Every test must protect a real flow (ex.: “user can login”, “user sees error on invalid email”).

## 2. File structure, naming & language

- **Co-location**: Place the test file next to the code it covers.
  - `ComponentName.tsx` → `ComponentName.test.tsx`
  - Pages in `src/pages/...` seguem o mesmo padrão.
- **Language rule**:
  - Descriptions in **English** (`describe`, `it`, helper names).
  - Text in assertions must match the **UI language (pt-BR)**.

  _Bad:_

  ```typescript
  it('deve mostrar erro quando o email for invalido', () => {
    expect(screen.getByText('Email inválido')).toBeInTheDocument();
  });
  ```

  _Good:_

  ```typescript
  it('shows error message when email is invalid', () => {
    expect(screen.getByText('Email inválido')).toBeInTheDocument();
  });
  ```

## 3. How to write tests

### 3.1 Arrange – Act – Assert

- **Arrange**: Render component/página, envolver com `BrowserRouter`, `AuthProvider` etc. quando necessário.
- **Act**: Interações do usuário usando `userEvent` (cliques, digitação, blur, submit).
- **Assert**: Verificar resultado visível (texto, botões desabilitados, navegação efetiva, loading sumindo).

### 3.2 Query priority (React Testing Library)

1. `getByRole` (buttons, links, headings) – preferido, melhora A11y.
2. `getByLabelText` (inputs de formulário).
3. `getByText` (conteúdo estático).
4. `getByTestId` – apenas quando as alternativas acima não forem suficientes.
5. **FORBIDDEN**: `container.querySelector` (salvo casos muito específicos e comentados).

### 3.3 Async & mocks

- Use `await userEvent...` para interações assíncronas.
- Use `await waitFor(() => ...)` ou `findBy*` para elementos que aparecem depois (ex.: mensagens de erro, loaders).
- **Mocking**:
  - Mockar APIs e integrações externas.
  - Responses devem refletir cenários reais: sucesso (200) e erros (400/500) importantes para o produto.

## 4. Checklist: what to test?

Antes de finalizar um arquivo de teste, confira se você cobre:

- [ ] **Happy path**: o fluxo principal funciona (ex.: submit válido, navegação correta).
- [ ] **Edge cases**: campos vazios, formatos inválidos, estados de erro.
- [ ] **Async states**: spinners (ex.: `PageLoading`), estados de loading, sumiço do loading após conclusão.
- [ ] **Acessibilidade básica**: `role`, `aria-*` relevantes para o comportamento.

## 5. Anti-patterns to avoid

- Tests that “pass” but verify nothing relevante (ex.: só checar se `<div>` existe).
- Tests acoplados a detalhes visuais (classes específicas) sem necessidade funcional.
- Duplicar implementação nos testes (testar que função X foi chamada, em vez do efeito visível para o usuário).
